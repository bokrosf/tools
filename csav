#!/bin/bash

# Configurable variables
readonly config_checkout_path="/home/bokrosf"
readonly repository_name="configs"
readonly repository_url="https://github.com/bokrosf/$repository_name"
readonly jump_terminal_command='alacritty --working-directory "$(config_root_path)" &'

print_error()
{
  echo "csav: $1"
}

config_root_path()
{
  echo "$config_checkout_path/$repository_name"
}

require_root_privilege()
{
  if [[ $(id -u) -ne 0 ]]
  then
    print_error "must be superuser to perform this operation"
    exit 1
  fi
}

enforce_initialization()
{
  if [[ ! -d $(config_root_path)/.git ]]
  then
    print_error "init required, not a git repository: '$(config_root_path)'"
    echo "  use \"csav init\" to clone the repository"
    exit 1
  fi
}

access_config_git()
{
  git -C "$(config_root_path)" "$@"
}

help()
{
  # TODO Implement displaying usage.
  echo "help"
}

init()
{
  require_root_privilege

  # Obtaining the repository.
  if [[ -d $(config_root_path)/.git ]]
  then
    echo "initialized"
    return 0
  fi

  mkdir -p "$(config_root_path)"

  if [[ $? -ne 0 ]]
  then
    print_error "directory creation failed -- '$(config_root_path)'"
    exit 1
  fi

  git clone "$repository_url" "$(config_root_path)"

  if [[ $? -ne 0 ]]
  then
    rm -rf "$(config_root_path)"
    print_error "repository cloning failed -- '$repository_url'"
    exit 1
  fi

  # Setting privileges of files and directories.
  owner_user_name="$SUDO_USER"

  if [[ -z $owner_user_name ]]
  then
    owner_user_name="$USER"
  fi

  chown -R "$owner_user_name": "$(config_root_path)"
  cd "$(config_root_path)"

  for root_item in $(ls -A | grep -v -e '.git' -e 'README.md' -e 'home')
  do
    chown -R root: "$root_item"
  done

  if [[ -e home ]]
  then
    chown root: home
  fi

  for user_name in $(ls -A home)
  do
    chown -R "$user_name": "home/$user_name"
  done

  echo "initialized"
}

list()
{
  find "$(config_root_path)" -type f ! -path "*.git*" ! -path "*README.md" \
    | sed "s|"$(config_root_path)"||"
}

add()
{
  enforce_initialization

  for path in "$@"
  do
    cp -a --parent "$(realpath "$path")" "$(config_root_path)"
  done

  access_config_git add "*"
}

addcomm()
{
  add "$@"
  commit
}

rm()
{
  for path in "$@"
  do
    access_config_git rm -r "$(config_root_path)$path"
  done
}

apply()
{
  require_root_privilege
  local destination_path="$1"

  if [[ -z "$destination_path" ]]
  then
    print_error "destination path must be supplied"
    exit 1
  fi

  enforce_initialization
  cd "$(config_root_path)"

  for saved_item in $(ls -A | grep -v -e '.git' -e 'README.md')
  do
    cp -a "$saved_item" "$destination_path"
  done
}

backup()
{
  add $(list)
}

restoreall()
{
  enforce_initialization
  access_config_git restore -S -W "*"
  access_config_git clean -dfx
}

jump()
{
  enforce_initialization

  if [[ -z $jump_terminal_command ]]
  then
    print_error "can not jump to '$(config_root_path)', 'jump_terminal_command' variable must be set"
    exit 1
  fi

  eval "$jump_terminal_command"
}

if [[ -z $config_checkout_path ]]
then
  print_error "'config_checkout_path' variable must be set"
  exit 1
fi

if [[ -z $repository_name ]]
then
  print_error "'repository_name' variable must be set"
  exit 1
fi

if [[ -z $repository_url ]]
then
  print_error "'repository_url' variable must be set"
  exit 1
fi

readonly command="$1"

case "$command" in
  help \
  | init \
  | list \
  | add \
  | addcomm \
  | rm \
  | apply \
  | backup \
  | restoreall \
  | jump)
    shift
    $command "$@"
    ;;
  restore \
  | commit \
  | pull \
  | push \
  | status \
  | diff )
    access_config_git "$@"
    ;;
  "")
    print_error "no operation specified (use 'help' for help)"
    ;;
  *)
    print_error "invalid operation -- '$1'"
    ;;
esac